# Pedestrian Blocker (видео с регистратора)

Приложение на **Python 3.14** с GUI на **CustomTkinter** для обнаружения **пешеходов**, которые **мешают движению авто** на видео с регистратора.

В основе детекции — **Ultralytics YOLO** (можно выбрать модель и устройство: CPU/CUDA/MPS).

## Возможности

- Открытие видеофайла и предпросмотр
- Детекция класса **person** (пешеход)
- Определение “мешает” через **настраиваемую зону интереса (ROI)** в процентах кадра
- Аннотация: bbox + ROI + статус “мешает”
- Экспорт:
  - аннотированного видео (опционально)
  - JSON-лога событий (“мешает”: интервалы времени)

## Установка

Рекомендуется виртуальное окружение:

```bash
python3.14 -m venv .venv
source .venv/bin/activate
python -m pip install -U pip
pip install -r requirements.txt
```

Если у вас `python3.14` не найден (как в терминале “command not found”), поставьте Python 3.14 одним из способов:

- **Homebrew**:

```bash
brew install python@3.14
python3.14 -V
```

- **pyenv**:

```bash
brew install pyenv
pyenv install 3.14.2
pyenv local 3.14.2
python -V
```

Примечание по **PyTorch**: на macOS/M1-M4 обычно удобнее ставить сборку с **MPS**, на NVIDIA — с **CUDA**. `ultralytics` подтянет `torch`, но при проблемах поставьте PyTorch согласно официальной инструкции и затем повторите `pip install -r requirements.txt`.

## Запуск

```bash
python run_app.py
```

Альтернатива (после установки пакета):

```bash
pip install -e .
python -m pedblock
```

## Как работает “пешеход мешает”

Считаем, что пешеход “мешает”, если **центр bbox** попадает в прямоугольник ROI (задаётся процентами кадра), и bbox не слишком маленький (порог площади в процентах кадра).

ROI можно настроить в UI под ваш ракурс регистратора (обычно — нижняя центральная часть кадра).

### Детекция проезжей части и авто danger_zone (эвристика)

В UI есть опция **«Авто danger_zone (по проезжей части)»**: вместо ручного прямоугольного ROI система пытается выделить **проезжую часть (drivable area)** и уже по ней строит `danger_zone`.

#### Как определяется проезжая часть (что именно реализовано в этом проекте)

Мы используем лёгкую эвристику (без нейросегментации), но уже **гибридную**, чтобы маска была плотнее и стабильнее:

- Берём **нижнюю часть кадра** (там обычно находится дорога) и режем боковые поля, чтобы уменьшить шум (обочина/тротуар/небо).
- Строим карту границ **Canny**.
- (Опционально) накладываем цветовой фильтр под разметку **white/yellow** в пространстве HLS, чтобы усилить «дорожные» контуры.
- Ищем отрезки **HoughLinesP** и строим **геометрический коридор** между доминирующими левой/правой линиями.
- Далее (точнее): внутри коридора оцениваем **цвет дороги** по нижней центральной полосе (в LAB/HSV), порогуем «похожесть на дорогу», чистим морфологией и берём крупнейшую компоненту, связанную с низом кадра — получаем более плотную **маску проезжей части**.
- Дальше `danger_zone` строится **по маске**: берём «ближнюю» часть дороги (нижнюю полосу) и оцениваем левую/правую границы, чтобы получить устойчивую трапецию.

Это по смыслу близко к pipeline из OpenADAS (там дорога/полоса определяется через сегментацию + геометрию и дальше используется для предупреждений), см. документацию: [OpenADAS Documentation](https://raw.githubusercontent.com/vietanhdev/open-adas/master/docs/open-adas.md).

#### Перспектива (OpenADAS-style): калибровка bird-view

В OpenADAS отдельно описана **калибровка камеры для перспективного преобразования** (bird’s-eye view) по 4 точкам и измерениям \(L1,L2,W1,W2\). В этом проекте добавлен аналогичный режим для **стабильного выделения проезжей части**:

- Включите чекбокс **«Перспектива (OpenADAS): bird-view калибровка»**.
- Нажмите **«Калибровка перспективы…»** и на текущем кадре кликните **4 точки** в порядке:
  - TL (дальний левый)
  - TR (дальний правый)
  - BR (ближний правый)
  - BL (ближний левый)
- Введите метры:
  - **L1/L2** — расстояния до ближней/дальней линии
  - **W1/W2** — ширина дороги на этих дистанциях
- Нажмите **Сохранить** — калибровка запишется в `data/camera_calib.json` и будет использоваться для маски дороги (маска считается в bird-view и проецируется обратно на исходный кадр).

#### Road Debug (полезно для доводки под ваше видео)

В блоке ROI есть переключатель **Road Debug (превью)** — он показывает промежуточные карты, чтобы быстро понять, *почему* маска дороги получилась такой:

- **Canny**: границы (что вообще “видит” детектор линий)
- **Коридор**: грубая трапеция/коридор между левой/правой границей
- **Seed**: область, по которой оценивается “цвет дороги” (низ/центр кадра, внутри коридора)
- **Dist**: карта “насколько пиксель похож на дорогу” (меньше = ближе)
- **Candidate**: пороговая бинарная маска по Dist до связных компонент
- **Final**: финальная маска после CC и ограничений

Слайдер **«Строгость маски»** меняет порог похожести цвета: меньше → строже (меньше лишнего), больше → шире (меньше дырок, но риск “залезть” на фон).

Если на конкретном видео разметка/край дороги видны плохо, повысьте стабильность так:

- Включите авто-режим и нажмите **«Пересчитать по кадру»** на характерном кадре.
- Увеличьте **«Авто-обновление (кадров)»** (реже пересчитывать — меньше “дрожания”).


